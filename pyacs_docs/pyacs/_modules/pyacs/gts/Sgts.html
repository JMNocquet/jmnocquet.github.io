

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyacs.gts.Sgts &mdash; pyacs 0.65.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyacs
          

          
          </a>

          
            
            
              <div class="version">
                0.65.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../foreword.html">What is pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../libraries.html">pyacs core libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gts.html">Time series library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../make_time_series.html">pyacs_make_time_series.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../time_series.html">Time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Full code documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyacs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyacs.gts.Sgts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyacs.gts.Sgts</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Super Class of Geodetic Time Series Class &amp; methods (Sgts)</span>
<span class="sd">    Sgts is a record of Gts and enables to apply methods at the same time to various Gts</span>
<span class="sd">        </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pyacs.gts.Gts</span> <span class="kn">import</span> <span class="n">Gts</span>

<div class="viewcode-block" id="Sgts"><a class="viewcode-back" href="../../../sgts_class.html#pyacs.gts.Sgts.Sgts">[docs]</a><span class="k">class</span> <span class="nc">Sgts</span><span class="p">:</span>


    <span class="c1">###################################################################</span>
    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">add_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name_filter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sites</span><span class="o">=</span><span class="p">[],</span><span class="n">lexclude</span><span class="o">=</span><span class="p">[],</span><span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xyz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">###################################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">=</span><span class="n">ts_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">=</span><span class="n">name_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="k">if</span> <span class="n">read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_ts</span><span class="p">(</span><span class="n">ts_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">name_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">add_key</span><span class="o">=</span><span class="n">add_key</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">sites</span><span class="o">=</span><span class="n">sites</span><span class="p">,</span><span class="n">lexclude</span><span class="o">=</span><span class="n">lexclude</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span></div>



<span class="c1">###################################################################</span>
<span class="c1">##  METHODS IMPORT</span>
<span class="c1">###################################################################</span>

<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.add_offsets_dates</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.append</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.copy</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.delts</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.frame</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.gts</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.has_ts</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.lGts</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.n</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.lcode</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.medvel</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.read_gmt</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.read_gts_conf</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.read_soln</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.read_ts</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.same_site</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.save_velocity</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.sel_rectangle</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.sel_period</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.show_map</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.stat_site</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.sub</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.to_displacement</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.write_pck</span>
<span class="kn">import</span> <span class="nn">pyacs.gts.Sgts_methods.common_mode</span>


<span class="n">Sgts</span><span class="o">.</span><span class="n">append</span>             <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">append</span><span class="o">.</span><span class="n">append</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">copy</span>               <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">delts</span>              <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">delts</span><span class="o">.</span><span class="n">delts</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">frame</span>              <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">frame</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">gts</span>                <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">gts</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">has_ts</span>             <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">has_ts</span><span class="o">.</span><span class="n">has_ts</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">lGts</span>               <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">lGts</span><span class="o">.</span><span class="n">lGts</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">n</span>                  <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">n</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">lcode</span>              <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">lcode</span><span class="o">.</span><span class="n">lcode</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">medvel</span>             <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">medvel</span><span class="o">.</span><span class="n">medvel</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">read_gmt</span>           <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">read_gmt</span><span class="o">.</span><span class="n">read_gmt</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">read_gts_conf</span>      <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">read_gts_conf</span><span class="o">.</span><span class="n">read_gts_conf</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">read_soln</span>          <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">read_soln</span><span class="o">.</span><span class="n">read_soln</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">read_ts</span>            <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">read_ts</span><span class="o">.</span><span class="n">read_ts</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">same_site</span>          <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">same_site</span><span class="o">.</span><span class="n">same_site</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">save_velocity</span>      <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">save_velocity</span><span class="o">.</span><span class="n">save_velocity</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">sel_rectangle</span>      <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">sel_rectangle</span><span class="o">.</span><span class="n">sel_rectangle</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">sel_period</span>         <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">sel_period</span><span class="o">.</span><span class="n">sel_period</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">show_map</span>           <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">show_map</span><span class="o">.</span><span class="n">show_map</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">stat_site</span>          <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">stat_site</span><span class="o">.</span><span class="n">stat_site</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">sub</span>                <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">sub</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">to_displacement</span>    <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">to_displacement</span><span class="o">.</span><span class="n">to_displacement</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">write_pck</span>          <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">write_pck</span><span class="o">.</span><span class="n">write_pck</span>
<span class="n">Sgts</span><span class="o">.</span><span class="n">common_mode</span>        <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">gts</span><span class="o">.</span><span class="n">Sgts_methods</span><span class="o">.</span><span class="n">common_mode</span><span class="o">.</span><span class="n">common_mode</span>


<span class="c1"># </span>
<span class="c1">#     ###################################################################</span>
<span class="c1">#     def gts(self , method , *args , **kwargs):</span>
<span class="c1">#     ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         apply a gts method to all Gts instance of the current Sgts object</span>
<span class="c1">#          </span>
<span class="c1">#         :param method: Gts method to be applied as string</span>
<span class="c1">#         :param *arg: arguments for the Gts method to be applied </span>
<span class="c1">#         :param **kwarg: keyword arguments for the Gts method to be applied </span>
<span class="c1">#         </span>
<span class="c1">#         :example : ts.gts(&#39;detrend&#39;,periods=[2010.0,2013.0])</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#         verbose = kwargs.get(&#39;verbose&#39;, False)        </span>
<span class="c1">#          </span>
<span class="c1">#         new_ts = Sgts(read=False)</span>
<span class="c1">#          </span>
<span class="c1">#         lsite=self.lcode()</span>
<span class="c1">#          </span>
<span class="c1">#         for site in sorted(lsite):</span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 print(&#39;-- processing &#39;, site)</span>
<span class="c1">#             </span>
<span class="c1">#             try:</span>
<span class="c1">#                 func = getattr(self.__dict__[site], method)</span>
<span class="c1">#                 new_ts.append(func(*args, **kwargs) )</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&#39;!!!WARNING: problem with method %s on gts %s. Removed from output&#39; % ( method, site ))</span>
<span class="c1">#         return( new_ts )</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#     ###################################################################</span>
<span class="c1">#     def stack(self , verbose=True):</span>
<span class="c1">#     ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Compute the stack of the Gts in the current Sgts</span>
<span class="c1">#          </span>
<span class="c1">#         :return Gts: the stacked Gts with &#39;_STK&#39; code</span>
<span class="c1">#         </span>
<span class="c1">#         :note 1: the stack is performed on the .data attribute only with uncertainties set to zero.</span>
<span class="c1">#         :note 2: No detrend is applied.</span>
<span class="c1">#         :note 3: Gap in data are not handled and time series are assumed to have exactly the same number of data at the same dates.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         new_gts = Gts()</span>
<span class="c1">#         new_gts.code = &#39;_STK&#39;</span>
<span class="c1">#         </span>
<span class="c1">#         data = None</span>
<span class="c1">#         </span>
<span class="c1">#         for code in self.lcode():</span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 print(&quot;-- adding %s in stack.&quot; % code)</span>
<span class="c1">#             </span>
<span class="c1">#             wgts = self.__dict__[code]</span>
<span class="c1">#             try:</span>
<span class="c1">#                 if data is None:</span>
<span class="c1">#                     data = wgts.data</span>
<span class="c1">#                     np_date = wgts.data[:,0]</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     data = data + wgts.data</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&quot;!!!WARNING: some problem (likely missing data) for time series: %s&quot; % code)</span>
<span class="c1">#             </span>
<span class="c1">#         new_gts.data = data</span>
<span class="c1">#         new_gts.data[:,0] = np_date</span>
<span class="c1">#                 </span>
<span class="c1">#         return new_gts</span>
<span class="c1"># </span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def lcode(self,lexclude=[],linclude=[]):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Returns the list of Gts codes in the current Sgts</span>
<span class="c1">#         exclude is a list of code to be excluded</span>
<span class="c1">#         </span>
<span class="c1">#         :param lexclude: list of sites to be excluded</span>
<span class="c1">#         :param linclude: list of sites to be included, excluding all other.</span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # import</span>
<span class="c1">#         import re </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         lcode=[]</span>
<span class="c1">#         if linclude != []:</span>
<span class="c1">#             for k in list(self.__dict__.keys()):</span>
<span class="c1">#                 if ((re.match(&#39;[A-Z0-9_]{4}&#39;,k))) and (k not in lexclude) and (k in linclude):lcode.append(k)</span>
<span class="c1">#         else:</span>
<span class="c1">#             for k in list(self.__dict__.keys()):</span>
<span class="c1">#                 if ((re.match(&#39;[A-Z0-9_]{4}&#39;,k))) and (k not in lexclude):lcode.append(k)</span>
<span class="c1"># </span>
<span class="c1">#         return(lcode)</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def lGts(self,lexclude=[],linclude=[]):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Returns the list of Gts in the current Sgts</span>
<span class="c1">#         :param lexclude: list of sites to be excluded</span>
<span class="c1">#         :param linclude: list of sites to be included, excluding all other.</span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         lsite=self.lcode(lexclude=lexclude,linclude=linclude)</span>
<span class="c1">#         Lgts=[]</span>
<span class="c1">#         for site in sorted(lsite):Lgts.append(self.__dict__[site])</span>
<span class="c1">#         return(Lgts)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def delts(self,code):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Delete a time series from an Sgts instance</span>
<span class="c1"># </span>
<span class="c1">#         :param code: code to be excluded</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#         delattr(self, code)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def sub(self,lexclude=[],linclude=[]):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Returns a new Sgts instance excluding Gts with code in lexclude and keeping Gts with code in include</span>
<span class="c1"># </span>
<span class="c1">#         :param lexclude: list of sites to be excluded</span>
<span class="c1">#         :param linclude: list of sites to be included, excluding all other.</span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#             </span>
<span class="c1">#         if linclude != []:</span>
<span class="c1">#             sub_Sgts = Sgts(read=False)</span>
<span class="c1">#             for code in linclude:</span>
<span class="c1">#                 if code not in lexclude:</span>
<span class="c1">#                     sub_Sgts.append(self.__dict__[code].copy())</span>
<span class="c1">#         else:</span>
<span class="c1">#             sub_Sgts = self.copy()</span>
<span class="c1">#             for code in lexclude:</span>
<span class="c1">#                 sub_Sgts.delts(code)</span>
<span class="c1">#         </span>
<span class="c1">#         return(sub_Sgts)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def append(self, gts):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Append a Gts to the current Sgts</span>
<span class="c1">#         </span>
<span class="c1">#         :param gts: Gts instance to be appended to the current Sgts instance</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         self.__dict__[gts.code]=gts</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def has_ts(self, code):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Tests whether a time series exists in the current Sgts instance</span>
<span class="c1">#         </span>
<span class="c1">#         :param code: 4-character code</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         def has_key(key, data):</span>
<span class="c1">#             return True if key in data else False</span>
<span class="c1"># </span>
<span class="c1">#         if has_key(code , self.__dict__):</span>
<span class="c1">#             return True</span>
<span class="c1">#         else:</span>
<span class="c1">#             return False</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def common_mode(self, lGts, lGts_ref, date, verbose=True):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Common mode filter</span>
<span class="c1">#         </span>
<span class="c1">#         :todo use Sgts objects instead of lists</span>
<span class="c1">#         </span>
<span class="c1">#         lGts    : list of time series to which the common mode will be applied</span>
<span class="c1">#         lGts_ref: list of time series used to calculates the common mode</span>
<span class="c1">#         date    : period where common mode will be applied</span>
<span class="c1">#         Output:</span>
<span class="c1">#         lGts    : filtered time series</span>
<span class="c1">#         common_ts: time series of common mode</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1">#         import pyacs.lib.astrotime</span>
<span class="c1"># </span>
<span class="c1">#         # homogenize dates</span>
<span class="c1">#         for gts in lGts_ref:</span>
<span class="c1">#             np_dates=gts.data[:,0]</span>
<span class="c1">#             np_dates_mjd = pyacs.lib.astrotime.decyear2mjd(np_dates)</span>
<span class="c1">#             np_dates_mjd = np.trunc( np_dates_mjd ) + 0.5</span>
<span class="c1">#             gts.data[:,0] = np_dates_mjd</span>
<span class="c1"># </span>
<span class="c1">#         # converts mjd dates back to decimal year</span>
<span class="c1">#         for gts in lGts_ref:</span>
<span class="c1">#             gts.data[:,0] = pyacs.lib.astrotime.mjd2decyear(gts.data[:,0])</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         # get the list of dates of ref</span>
<span class="c1">#         ldates=np.array([])</span>
<span class="c1">#         for gts in lGts_ref:</span>
<span class="c1">#             lindex=np.where((gts.data[:,0] &gt;= date[0]) &amp; (gts.data[:,0] &lt;= date[-1]))</span>
<span class="c1">#             ldates=np.append(ldates,gts.data[lindex,0])</span>
<span class="c1">#             ldates=np.unique(np.array(ldates))</span>
<span class="c1">#         # calculates the common mode</span>
<span class="c1">#         if verbose:print(&quot;-- Calculating common mode&quot;)</span>
<span class="c1">#         common_mode=Gts(code=&#39;CMM1&#39;)</span>
<span class="c1">#         common_mode.data=np.zeros((1,7))</span>
<span class="c1"># </span>
<span class="c1">#         for date in ldates:</span>
<span class="c1"># </span>
<span class="c1">#             common_mode_date=np.zeros((1,7))</span>
<span class="c1">#             for gts in lGts_ref:</span>
<span class="c1">#                 #print &quot;  -- processing &quot;,gts.code</span>
<span class="c1">#                 if date in list(gts.data[:,0]):</span>
<span class="c1">#                     index=np.where(date==gts.data[:,0])</span>
<span class="c1">#                     common_mode_date=np.vstack((common_mode_date,gts.data[index[0],:7]))</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     print(&#39;-- date missing for &#39;,gts.code)</span>
<span class="c1">#             common_mode_date=np.delete(common_mode_date,0,axis=0)</span>
<span class="c1">#             </span>
<span class="c1">#             common_mode.data=np.vstack((common_mode.data,np.mean(common_mode_date,axis=0)))</span>
<span class="c1">#         common_mode.data=np.delete(common_mode.data,0,axis=0)</span>
<span class="c1">#         </span>
<span class="c1">#         common_mode.write_mb_file(&#39;.&#39;)  </span>
<span class="c1"># </span>
<span class="c1">#         if verbose:print(&quot;-- Removing common mode&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         lfiltered_gts=[]</span>
<span class="c1">#         </span>
<span class="c1">#         for gts in lGts:</span>
<span class="c1">#             print(&quot;  -- &quot;,gts.code)</span>
<span class="c1">#             filtered_ts=gts.substract_ts(common_mode)</span>
<span class="c1">#             if filtered_ts != None:</span>
<span class="c1">#                 lfiltered_gts.append(filtered_ts)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(gts.code,&quot; has no data common with reference sites&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1"># #        common_mode.data[:,0] = pyacs.mjd2decyear(common_mode.data[:,0])</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         # returns results</span>
<span class="c1">#         return(lfiltered_gts,common_mode)</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def write_pck(self,outfile, verbose=True):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         writes a Sgts object as a pck (pickle)</span>
<span class="c1">#         </span>
<span class="c1">#         :param outfile: output file name. If not provided, a pck extension will be added.</span>
<span class="c1">#         :param verbose: verbose mode</span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # import</span>
<span class="c1">#         import pickle</span>
<span class="c1">#         import os</span>
<span class="c1">#     </span>
<span class="c1">#         # add pck extension if not provided</span>
<span class="c1">#         </span>
<span class="c1">#         if outfile[-4:] != &#39;.pck&#39;:</span>
<span class="c1">#             outfile = outfile+&#39;.pck&#39;</span>
<span class="c1"># </span>
<span class="c1">#         os.makedirs( os.path.dirname( outfile ) , exist_ok=True )</span>
<span class="c1">#         ofile = open( outfile, &#39;wb&#39;) </span>
<span class="c1">#         pickle.dump(self , ofile , pickle.HIGHEST_PROTOCOL)</span>
<span class="c1">#         ofile.close()</span>
<span class="c1">#     </span>
<span class="c1">#         </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def read_ts(self,ts_dir=&#39;.&#39;, verbose=True, name_filter=&#39;&#39;, add_key=&#39;&#39;, sites=[],lexclude=[], type = None, xyz=True):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Reads time series, trying to guess the format. Current time series format supported are: pos, kenv, mb_file, cats, txyz (pyacs), track (NEU format for high rate)</span>
<span class="c1">#         </span>
<span class="c1">#         :param ts_dir: directory of time series files</span>
<span class="c1">#         :param name_filter: string used to filter time series name &#39;*name_filter*&#39;</span>
<span class="c1">#         :param add_key: adds a string before site code</span>
<span class="c1">#         :param sites: list of site codes to be read. Any other will be discarded.</span>
<span class="c1">#         :param lexclude: list of sites to be excluded from reading</span>
<span class="c1">#         :param type: specifies the format of the time series files. Choose among [&#39;pos&#39;, &#39;kenv&#39;, &#39;mb_file&#39;, &#39;cats&#39;, &#39;txyz&#39;, &#39;track&#39; , &#39;pride&#39;,&#39;pck&#39;]</span>
<span class="c1">#         :param xyz: for pos files, reads the XYZ coordinates rather than dNEU. This is the default.</span>
<span class="c1">#         </span>
<span class="c1">#         :return: an Sgts instance.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1"># </span>
<span class="c1">#         if verbose:</span>
<span class="c1">#             print(&#39;-- Reading directory: &#39;,ts_dir)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __pride_pos(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             </span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             </span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             lfile = glob.glob(ts_dir+&#39;/&#39;+&#39;pos_*&#39;+name_filter)</span>
<span class="c1">#             lcode = []</span>
<span class="c1">#             for ifile in lfile:</span>
<span class="c1">#                 if not os.path.isfile( ifile ): continue</span>
<span class="c1">#                 code = ifile[-4:].upper()</span>
<span class="c1">#                 if code not in lcode:</span>
<span class="c1">#                     lcode.append( code )</span>
<span class="c1">#                 </span>
<span class="c1">#             for code in lcode:</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Reading pride pos files for: %s &quot; % code )</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 lGts[code+add_key].read_pride_pos(tsdir=ts_dir , verbose=verbose )</span>
<span class="c1"># </span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __pride(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             </span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             lfile = glob.glob(ts_dir+&#39;/&#39;+&#39;kin_*&#39;+name_filter)</span>
<span class="c1">#             lcode = []</span>
<span class="c1">#             for ifile in lfile:</span>
<span class="c1">#                 if not os.path.isfile( ifile ): continue</span>
<span class="c1">#                 code = ifile[-4:].upper()</span>
<span class="c1">#                 if code not in lcode:</span>
<span class="c1">#                     lcode.append( code )</span>
<span class="c1">#                 </span>
<span class="c1">#             for code in lcode:</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Reading pride files for: %s &quot; % code )</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 lGts[code+add_key].read_pride(tsdir=ts_dir , verbose=verbose )</span>
<span class="c1"># </span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __tdp(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             </span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             ldat=sorted(glob.glob(ts_dir+&#39;/&#39;+&#39;*&#39;+name_filter+&#39;*.tdp&#39;))</span>
<span class="c1">#             for fdat in ldat:</span>
<span class="c1">#                 if not os.path.isfile( fdat ): continue</span>
<span class="c1">#                 mb_file=fdat.split(&#39;/&#39;)[-1][0:4]</span>
<span class="c1">#                 code=mb_file[0:4]</span>
<span class="c1">#                 if code not in sites and sites !=[]:continue</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Reading &quot;, mb_file)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 lGts[code+add_key].read_tdp(ifile=fdat,gmt=False)</span>
<span class="c1"># </span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __mb_files(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             ldat=sorted(glob.glob(ts_dir+&#39;/&#39;+&#39;*&#39;+name_filter+&#39;*.dat1&#39;))</span>
<span class="c1">#             for fdat in ldat:</span>
<span class="c1">#                 if not os.path.isfile( fdat ): continue</span>
<span class="c1">#                 mb_file=fdat[0:-1]</span>
<span class="c1">#                 code=mb_file[-12:-8]</span>
<span class="c1">#                 if code not in sites and sites !=[]:continue</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Reading &quot;, mb_file)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 lGts[code+add_key].read_mb_file(ifile=mb_file,gmt=False)</span>
<span class="c1"># </span>
<span class="c1">#             return(lGts)</span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __kenv(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             </span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             lkenv=sorted(glob.glob(ts_dir+&#39;/*.kenv&#39;))</span>
<span class="c1">#             for fkenv in lkenv:</span>
<span class="c1">#                 if not os.path.isfile( fkenv ): continue</span>
<span class="c1">#                 code=fkenv[-20:-9]</span>
<span class="c1">#                 if verbose:print(&quot;-- Reading &quot;, fkenv)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     lGts[code+add_key].read_kenv(fkenv,date_type=&#39;jd&#39;)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;!!! Error. Could not read &quot;,fkenv)</span>
<span class="c1">#                     del lGts[code+add_key]</span>
<span class="c1">#                     continue</span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __cats(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             lcats=sorted(glob.glob(ts_dir+&#39;/cats*.dat&#39;))</span>
<span class="c1">#             for cats in lcats:</span>
<span class="c1">#                 if not os.path.isfile( cats ): continue</span>
<span class="c1">#                 code=cats.split(&#39;cats_&#39;)[-1][:4].upper()</span>
<span class="c1">#                 if verbose:print(&quot;-- Reading &quot;, cats)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     lGts[code+add_key].read_cats_file(ifile=cats,gmt=False)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;!!! Error. Could not read &quot;,cats)</span>
<span class="c1">#                     del lGts[code+add_key]</span>
<span class="c1">#                     continue</span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __pos(ts_dir=ts_dir, name_filter=name_filter, add_key=add_key, verbose=verbose,xyz=True):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             lpos=sorted(glob.glob(ts_dir+&#39;/????*.pos&#39;))</span>
<span class="c1">#             import os</span>
<span class="c1">#             for pos_w_path in lpos:</span>
<span class="c1">#                 if not os.path.isfile( pos_w_path): continue</span>
<span class="c1">#                 _drive, path_and_file = os.path.splitdrive(pos_w_path)</span>
<span class="c1">#                 _path, pos = os.path.split(path_and_file)</span>
<span class="c1">#                 code=pos[:4]</span>
<span class="c1">#                 if code not in sites and sites !=[]:continue</span>
<span class="c1">#                 if verbose:print(&quot;-- Reading &quot;, pos)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 lGts[code+add_key].read_pos(tsfile=pos_w_path,xyz=xyz)</span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __ts_xyz(ts_dir=&#39;.&#39;,name_filter=None, verbose=False):</span>
<span class="c1">#             </span>
<span class="c1">#             import glob</span>
<span class="c1">#             import os</span>
<span class="c1">#             </span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             l_txyz=glob.glob(ts_dir+&#39;/*txyz.dat&#39;)</span>
<span class="c1">#             </span>
<span class="c1">#                 </span>
<span class="c1">#             ##############################################</span>
<span class="c1">#             def __read_txyz(file_name,lGts,verbose=False):</span>
<span class="c1"># </span>
<span class="c1">#                 &quot;&quot;&quot;</span>
<span class="c1">#                 Reads a single txyz.dat</span>
<span class="c1">#                 &quot;&quot;&quot;</span>
<span class="c1">#                 </span>
<span class="c1">#                 NP_STR_TXYZ=np.genfromtxt(file_name,dtype=str)</span>
<span class="c1">#                 NP_CODE=NP_STR_TXYZ[:,2]</span>
<span class="c1">#                 NP_DATE=np.array(NP_STR_TXYZ[:,1],dtype=float)</span>
<span class="c1">#                 NP_XYZ=np.array(NP_STR_TXYZ[:,4:],dtype=float)</span>
<span class="c1">#             </span>
<span class="c1">#                 for i in np.arange(NP_CODE.shape[0]):</span>
<span class="c1">#                     code = NP_CODE[i]</span>
<span class="c1">#                     </span>
<span class="c1">#                     if code in list(lGts.keys()):</span>
<span class="c1">#                         lGts[code].add_obs_xyz(NP_DATE[i],NP_XYZ[i],in_place=True,check=False)</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         new_gts=Gts(code=code)</span>
<span class="c1">#                         new_gts.add_obs_xyz(NP_DATE[i],NP_XYZ[i],in_place=True,check=False)</span>
<span class="c1">#                         lGts[code]=new_gts</span>
<span class="c1">#             </span>
<span class="c1">#                 return(lGts)</span>
<span class="c1">#             </span>
<span class="c1">#             i=1</span>
<span class="c1">#             for txyz in l_txyz:</span>
<span class="c1">#                 if not os.path.isfile( txyz ): continue</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&#39;-- Reading &#39;,txyz,i,&#39;/&#39;,len(l_txyz))</span>
<span class="c1">#                     i = i + 1</span>
<span class="c1">#                     </span>
<span class="c1">#                 lGts=__read_txyz(txyz, lGts,verbose=verbose)</span>
<span class="c1">#             </span>
<span class="c1">#             for code in sorted( lGts.keys() ):</span>
<span class="c1">#                 </span>
<span class="c1">#                 gts = lGts[code]</span>
<span class="c1">#                 </span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&#39;-- Generating NEU from XYZ for &#39;,gts.code)</span>
<span class="c1">#                 gts.xyz2neu(corr=False)</span>
<span class="c1">#                 </span>
<span class="c1">#                 if not gts.cdata():</span>
<span class="c1">#                     sys.exit()</span>
<span class="c1">#                 </span>
<span class="c1">#             return(lGts)</span>
<span class="c1">#             </span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         def __track_NEU(ts_dir=&#39;.&#39;, name_filter=name_filter, add_key=add_key, verbose=verbose):</span>
<span class="c1">#             import glob</span>
<span class="c1">#             lGts={}</span>
<span class="c1">#             ltrack=sorted(glob.glob(ts_dir+&#39;/*.NEU.*&#39;))</span>
<span class="c1">#             import os</span>
<span class="c1">#             for track_w_path in ltrack:</span>
<span class="c1">#                 if not os.path.isfile( track_w_path ): continue</span>
<span class="c1">#                 _drive, path_and_file = os.path.splitdrive(track_w_path)</span>
<span class="c1">#                 _path, track = os.path.split(path_and_file)</span>
<span class="c1">#                 code= track.split(&#39;.&#39;)[-2].upper()</span>
<span class="c1">#                 if code not in sites and sites !=[]:continue</span>
<span class="c1">#                 if verbose:print(&quot;-- Reading &quot;, track)</span>
<span class="c1">#                 lGts[code+add_key]=Gts(code=code)</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     lGts[code+add_key].read_track_NEU(tsfile=track_w_path)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;!!! Error. Could not read &quot;,track)</span>
<span class="c1">#                     del lGts[code+add_key]</span>
<span class="c1">#                     continue</span>
<span class="c1">#             return(lGts)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         # START</span>
<span class="c1"># </span>
<span class="c1">#         lGts={}</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # PCK FORMAT</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # Added JMN 22/08/2019</span>
<span class="c1">#         # Sgts saved as a pickle dump</span>
<span class="c1">#         if type is None or type==&#39;pck&#39;:</span>
<span class="c1">#             import glob</span>
<span class="c1">#             lpck = glob.glob( self.dir+&#39;/*.pck&#39; )</span>
<span class="c1">#             if lpck != []:</span>
<span class="c1">#                 pck = lpck[-1]</span>
<span class="c1">#                 # read Sgts from pickle</span>
<span class="c1">#                 import pickle</span>
<span class="c1">#                 with open( pck, &quot;rb&quot;) as f:</span>
<span class="c1">#                     ts = pickle.load(f)</span>
<span class="c1">#                 f.close()</span>
<span class="c1">#                 </span>
<span class="c1">#                 for code in ts.lcode():</span>
<span class="c1">#                     lGts[code] = ts.__dict__[code]</span>
<span class="c1">#                 </span>
<span class="c1">#                 print(&quot;-- Sgts read from PYACS pck file: %s&quot; % (pck) )</span>
<span class="c1">#             else:</span>
<span class="c1">#             # no pck file    </span>
<span class="c1">#                 if verbose:print(&quot;-- No PYACS pck file found&quot;)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # PRIDE POS</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;pride_pos&#39;:</span>
<span class="c1">#             lGts_pride_pos = __pride_pos(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_pride_pos=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No pride pos files found&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 lGts=lGts_pride_pos</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # PRIDE</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;pride&#39;:</span>
<span class="c1">#             lGts_pride = __pride(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_pride=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No pride_files found&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 lGts=lGts_pride</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # MB_FILE</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;mb_file&#39;:</span>
<span class="c1">#             lGts_mb_files=__mb_files(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_mb_files=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No mb_files found&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 lGts=lGts_mb_files</span>
<span class="c1">#                 </span>
<span class="c1">#                 try:</span>
<span class="c1">#                     self.read_gmt(verbose=verbose, gmt=self.dir+&#39;/../stat/pyacs_void.gmt&#39;)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;! Warning: Could not read a gmt file to populate Gts attributes lon,lat,h &amp; X0,Y0,Z0 for mb_files&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # TDP</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;tdp&#39;:</span>
<span class="c1">#             lGts_mb_files=__tdp(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_mb_files=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No tdp_files found&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 lGts=lGts_mb_files</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     self.read_gmt(verbose=verbose, gmt=self.dir+&#39;/../stat/pyacs_void.gmt&#39;)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;! Warning: Could not read a gmt file to populate Gts attributes lon,lat,h &amp; X0,Y0,Z0 for mb_files&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # KENV</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;kenv&#39;:</span>
<span class="c1">#             lGts_kenv=__kenv(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_kenv=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No kenv file found&quot;)</span>
<span class="c1">#             else:lGts=lGts_kenv</span>
<span class="c1">#         </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # CATS</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;cats&#39;:</span>
<span class="c1">#             lGts_cats=__cats(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_cats=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No cats file found&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 lGts=lGts_cats</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     self.read_gmt(verbose=verbose, gmt=self.dir+&#39;/../stat/pyacs_void.gmt&#39;)</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     print(&quot;! Warning: Could not read a gmt file to populate Gts attributes lon,lat,h &amp; X0,Y0,Z0 for mb_files&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # POS FORMAT</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;pos&#39;:</span>
<span class="c1">#             lGts_pos=__pos(ts_dir=self.dir,verbose=verbose,xyz=xyz)</span>
<span class="c1">#             if lGts_pos=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No Gamit/Globk pos file found&quot;)</span>
<span class="c1">#             else:lGts=lGts_pos</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # TXYZ FORMAT</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;txyz&#39;:</span>
<span class="c1">#             lGts_txyz=__ts_xyz(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_txyz=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No pyacs t_xyz file found&quot;)</span>
<span class="c1">#             else:lGts=lGts_txyz</span>
<span class="c1"># </span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         # TRACK FORMAT</span>
<span class="c1">#         #######################################################################</span>
<span class="c1">#         if type is None or type==&#39;track&#39;:</span>
<span class="c1">#             lGts_track=__track_NEU(ts_dir=self.dir,verbose=verbose)</span>
<span class="c1">#             if lGts_track=={}:</span>
<span class="c1">#                 if verbose:print(&quot;-- No Gamit/Globk track NEU file found&quot;)</span>
<span class="c1">#             else:lGts=lGts_track</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         for gts in list(lGts.values()):</span>
<span class="c1">#             if gts.code not in lexclude:</span>
<span class="c1">#                 print(&#39;-- adding &#39;, gts.code)</span>
<span class="c1">#                 self.append(gts)</span>
<span class="c1"># </span>
<span class="c1">#         if verbose:</span>
<span class="c1">#             print(&#39;-- read &#39;,len(self.lcode() ),&#39; time series in directory &#39;,ts_dir)</span>
<span class="c1">#     </span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def read_gmt(self,gmt=True,verbose=False,vel=False):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Reads a gmt psvelo file and populates lon and lat attributes for each Gts of Sgts</span>
<span class="c1">#         </span>
<span class="c1">#         :param gmt: if True tries to read &#39;/../stat/pyacs_void.gmt&#39;, if a string then it is the gmt file to be read. </span>
<span class="c1">#         :param verbose: verbose mode</span>
<span class="c1">#         :param vel: boolean. If True, fills the .velocity attribute of every time series with the values read in the gmt file.</span>
<span class="c1">#         </span>
<span class="c1">#         :note: this method is always in place.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#         if gmt==True:</span>
<span class="c1">#             gmt_file=self.dir+&#39;/../stat/pyacs_void.gmt&#39;</span>
<span class="c1">#         if  isinstance(gmt,str):</span>
<span class="c1">#             gmt_file=gmt</span>
<span class="c1">#         </span>
<span class="c1">#         if gmt != False:</span>
<span class="c1">#             if verbose:print(&quot;-- Importing modules Velocity_Field, Gpoint &quot;,gmt_file)</span>
<span class="c1">#     </span>
<span class="c1">#             from pyacs.lib.vel_field import Velocity_Field</span>
<span class="c1">#             </span>
<span class="c1">#             if verbose:print(&quot;-- Reading &quot;,gmt_file)</span>
<span class="c1">#             velf=Velocity_Field()</span>
<span class="c1">#             velf.read(file_name=gmt_file)</span>
<span class="c1">#             lsite=vel.lcode()</span>
<span class="c1">#             </span>
<span class="c1">#             for gts in self.lGts():</span>
<span class="c1">#                 if verbose:print(&quot;-- Processing &quot;,gts.code)</span>
<span class="c1">#                 if gts.code in lsite:</span>
<span class="c1">#                     M=velf.site(gts.code)</span>
<span class="c1">#                     gts.lon=M.lon</span>
<span class="c1">#                     gts.lat=M.lat</span>
<span class="c1">#                     if vel:</span>
<span class="c1">#                         gts.velocity=[M.Ve,M.Vn,0.0,M.SVe,M.SVn,0.0]</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def frame(self,frame=None,euler=None,w=None,verbose=False):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Rotates the time series according to an Euler pole.</span>
<span class="c1">#         User must provide either frame, euler or w.</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         :param frame: str, implemented values are &#39;soam&#39;,&#39;nas&#39;,&#39;nazca&#39;,&#39;inca&#39;,&#39;nas_wrt_soam&#39;,&#39;inca_wrt_soam&#39;.</span>
<span class="c1">#         :param euler: Euler values provided either as a \</span>
<span class="c1">#         string &#39;euler_lon/euler_lat/euler_w&#39;, a list [euler_lon,euler_lat,euler_w] or \</span>
<span class="c1">#         a 1D numpy array np.array([euler_lon,euler_lat,euler_w])</span>
<span class="c1">#         :param w: rotation rate vector in rad/yr, provided either as a \</span>
<span class="c1">#         string &#39;wx/wy/wz&#39;, a list [wx,wy,wz] or \</span>
<span class="c1">#         a 1D numpy array np.array([wx,wy,wz])  </span>
<span class="c1"># </span>
<span class="c1">#         :return: the new Sgts instance in new frame</span>
<span class="c1"># </span>
<span class="c1">#         :ref: All values for frames are from Nocquet et al., Nat Geosc., 2014.</span>
<span class="c1"># </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1">#         import pyacs.lib.euler</span>
<span class="c1">#         </span>
<span class="c1">#         # check arguments are OK</span>
<span class="c1">#         </span>
<span class="c1">#         if [frame,euler,w].count(None) != 2:</span>
<span class="c1">#             print(&#39;!!! ERROR: define either argument frame, euler or w &#39;)</span>
<span class="c1">#             return(None)</span>
<span class="c1">#         </span>
<span class="c1">#         # Euler poles taken from pygvel_pole_info.py</span>
<span class="c1">#         lEuler={}</span>
<span class="c1">#         lEuler[&#39;soam&#39;]=[-132.21,-18.83,0.121]</span>
<span class="c1">#         lEuler[&#39;nas&#39;]=[-97.52,6.48,0.359]</span>
<span class="c1">#         lEuler[&#39;nazca&#39;]=[-94.4,61.0,0.57]</span>
<span class="c1">#         lEuler[&#39;inca&#39;]=[-103.729,-1.344,0.1659]</span>
<span class="c1">#         lEuler[&#39;nas_wrt_soam&#39;]=[-83.40,15.21,0.287]</span>
<span class="c1">#         lEuler[&#39;inca_wrt_soam&#39;]=[-63.76,22.47,0.092]</span>
<span class="c1">#         </span>
<span class="c1">#         # check frame case is OK</span>
<span class="c1">#         if ( frame not in list(lEuler.keys())) and ( frame is not None):</span>
<span class="c1">#             print(&quot;!!! ERROR: requested frame &quot;,frame,&quot; not known&quot;)</span>
<span class="c1">#             print(&quot;!!! ERROR: available frames are: &quot;, list(lEuler.keys()))</span>
<span class="c1">#             return(None)</span>
<span class="c1">#         </span>
<span class="c1">#         # initialize new gts</span>
<span class="c1">#         </span>
<span class="c1">#         New_Sgts=Sgts(read=False)</span>
<span class="c1"># </span>
<span class="c1">#         # convert to Euler vector whatever the provided argument</span>
<span class="c1">#         </span>
<span class="c1">#         # case frame</span>
<span class="c1">#         if frame is not None:</span>
<span class="c1">#             euler_vector=np.array(lEuler[frame])</span>
<span class="c1"># </span>
<span class="c1">#         # case w as rotation rate vector</span>
<span class="c1">#         if w != None:</span>
<span class="c1"># </span>
<span class="c1">#             if ( isinstance(w,str) ) and &#39;/&#39; in w:</span>
<span class="c1">#                 w=np.array(list(map(float,w.split(&#39;/&#39;))))</span>
<span class="c1"># </span>
<span class="c1">#             if isinstance(w,list):</span>
<span class="c1">#                 w=np.array(w)</span>
<span class="c1">#             </span>
<span class="c1">#             if not isinstance(w,np.ndarray):</span>
<span class="c1">#                 print(&#39;!!! ERROR: argument w not understood: &#39;,w)</span>
<span class="c1">#                 return(None) </span>
<span class="c1">#             </span>
<span class="c1">#             euler_vector=np.array(pyacs.lib.euler.rot2euler([w[0],w[1],w[2]]))</span>
<span class="c1"># </span>
<span class="c1">#         # case euler vector</span>
<span class="c1">#         if euler is not None:</span>
<span class="c1"># </span>
<span class="c1">#             if ( isinstance(euler,str) ) and &#39;/&#39; in euler:</span>
<span class="c1">#                 euler=np.array(list(map(float,euler.split(&#39;/&#39;))))</span>
<span class="c1"># </span>
<span class="c1">#             if isinstance(euler,list):</span>
<span class="c1">#                 euler=np.array(euler)</span>
<span class="c1">#             </span>
<span class="c1">#             if not isinstance(euler,np.ndarray):</span>
<span class="c1">#                 print(&#39;!!! ERROR: argument euler not understood: &#39;,euler)</span>
<span class="c1">#                 return(None) </span>
<span class="c1">#             </span>
<span class="c1">#             euler_vector=np.array(euler)</span>
<span class="c1">#         </span>
<span class="c1">#         # converts the gts</span>
<span class="c1">#         </span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             if verbose:print(&quot;-- Processing &quot;,gts.code)</span>
<span class="c1">#             try:</span>
<span class="c1">#                 new_gts=gts.remove_pole(euler_vector,pole_type=&#39;euler&#39;,in_place=False, verbose=verbose)</span>
<span class="c1">#             except (RuntimeError, TypeError, NameError):</span>
<span class="c1">#                 print(&quot;!!! Error processing &quot;,gts.code)</span>
<span class="c1">#                 continue</span>
<span class="c1">#             if isinstance(new_gts,Gts):</span>
<span class="c1">#                 New_Sgts.append(new_gts)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(&quot;!!! Error processing &quot;,gts.code, &quot;!!! No time series created.&quot;)</span>
<span class="c1"># </span>
<span class="c1">#         return(New_Sgts)</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ## copy Sgts</span>
<span class="c1"># ###################################################################</span>
<span class="c1"># </span>
<span class="c1">#     def copy(self):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         makes a (deep) copy of the Sgts object</span>
<span class="c1">#         </span>
<span class="c1">#         :return : a new Sgts instance</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         import copy</span>
<span class="c1">#         </span>
<span class="c1">#         new_Sgts=copy.deepcopy(self)</span>
<span class="c1">#         return(new_Sgts)</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def read_gts_conf(self,gts_conf_file,verbose=False):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Reads a gts_conf_file</span>
<span class="c1">#         implemented commands in the file are:</span>
<span class="c1">#         #todo add_break      [site]  [date] # date is either [decyear] [doy year] [mday month year]</span>
<span class="c1">#         apply_offset   [site]  [offset_north,offset_east,offset_up] [date] # offset  applied is in mm, date is either [decyear] [doy year] [mday month year]</span>
<span class="c1">#         remove_offset   [site]  [offset_north,offset_east,offset_up] [date] # offset removed is in mm, date is either [decyear] [doy year] [mday month year]</span>
<span class="c1">#         #todo extract_periods [site] [date1,date2] # date is either [decyear] [doy year] [mday month year]</span>
<span class="c1">#         #todo exclude_periods [site] [date1,date2] # date is either [decyear] [doy year] [mday month year]</span>
<span class="c1">#         #todo remove_day    [site] [date]</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1">#         from pyacs.lib.astrotime import guess_date</span>
<span class="c1"># </span>
<span class="c1">#         New_Sgts=self.copy()</span>
<span class="c1"># </span>
<span class="c1">#         conf=open(gts_conf_file,&#39;r&#39;)</span>
<span class="c1"># </span>
<span class="c1">#         H_apply_offsets={}</span>
<span class="c1">#         H_offsets_dates={}</span>
<span class="c1">#         </span>
<span class="c1">#         for line in conf:</span>
<span class="c1">#             if len(line)&lt;5 or line[0]==&#39;#&#39;:continue</span>
<span class="c1">#             lline=line.split()</span>
<span class="c1">#             # apply_offset</span>
<span class="c1">#             if lline[0] in [&#39;apply_offset&#39;,&#39;remove_offset&#39;]:</span>
<span class="c1">#                 (code,sdn,sde,sdu,sdate)=lline[1:]</span>
<span class="c1">#                 if lline[0] == &#39;apply_offset&#39;:</span>
<span class="c1">#                     dn=float(sdn)/1000.0</span>
<span class="c1">#                     de=float(sde)/1000.0</span>
<span class="c1">#                     du=float(sdu)/1000.0</span>
<span class="c1"># </span>
<span class="c1">#                 if lline[0] == &#39;remove_offset&#39;:</span>
<span class="c1">#                     dn = -float(sdn)/1000.0</span>
<span class="c1">#                     de = -float(sde)/1000.0</span>
<span class="c1">#                     du = -float(sdu)/1000.0</span>
<span class="c1"># </span>
<span class="c1">#                 </span>
<span class="c1">#                 date=guess_date(sdate)</span>
<span class="c1">#                 if code in H_apply_offsets:</span>
<span class="c1">#                     if verbose:print(&#39;-- adding offset to &#39;,code,date,dn,de,du)</span>
<span class="c1">#                     H_apply_offsets[code]=np.vstack((H_apply_offsets[code],np.array([date,dn,de,du])))</span>
<span class="c1">#                     H_offsets_dates[code].append(date)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     print(&#39;-- adding new offset to &#39;,code,date,dn,de,du)</span>
<span class="c1">#                     H_apply_offsets[code]=np.array([[date,dn,de,du]])</span>
<span class="c1">#                     H_offsets_dates[code]=[date]</span>
<span class="c1">#         </span>
<span class="c1">#         # apply commands</span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             if verbose:print(&quot;-- Processing &quot;,gts.code)</span>
<span class="c1">#             if gts.code in H_apply_offsets:</span>
<span class="c1">#                 #gts.offsets_dates+=H_offsets_dates[gts.code]</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     New_Sgts.__dict__[gts.code]=gts.apply_offsets(H_apply_offsets[gts.code],verbose=verbose)</span>
<span class="c1">#                     if verbose:</span>
<span class="c1">#                         print(&quot;-- applying offset &quot;, H_apply_offsets[gts.code])</span>
<span class="c1">#                 except (RuntimeError, TypeError, NameError):</span>
<span class="c1">#                     print(&quot;!!! Error applying offset to &quot;,gts.code)</span>
<span class="c1">#                     continue</span>
<span class="c1"># #            else:</span>
<span class="c1"># #                new_gts=Gts.copy(gts)</span>
<span class="c1"># #            if isinstance(new_gts,Gts):</span>
<span class="c1"># #                New_Sgts.append(new_gts)</span>
<span class="c1"># #            else:</span>
<span class="c1"># #                print &quot;Error processing &quot;,gts.code, &quot;!!! No time series created.&quot;</span>
<span class="c1"># </span>
<span class="c1">#         return(New_Sgts)</span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1">#         </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def stat_site(self,lsite=[],lsite_file=None,verbose=False, save_dir=None):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         basic statistics about individual time series</span>
<span class="c1"># </span>
<span class="c1">#         :param lsite: list of selected sites for statistics </span>
<span class="c1">#         :param lsite_file: list of selected sites for statistics provided as a file</span>
<span class="c1">#         :param verbose: verbose mode</span>
<span class="c1">#         :param save_dir: directory where statistics files will be written </span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1">#         import os</span>
<span class="c1">#         </span>
<span class="c1">#         # Case lsite_file option</span>
<span class="c1">#         </span>
<span class="c1">#         if lsite_file:</span>
<span class="c1">#             f=open(lsite_file,&#39;r&#39;)</span>
<span class="c1">#             for line in f:</span>
<span class="c1">#                 lline=line.split()</span>
<span class="c1">#                 if (len(lline[0])!=4):continue</span>
<span class="c1">#                 lsite.append(line.split()[0])</span>
<span class="c1">#             f.close()</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         # save_dir case</span>
<span class="c1"># </span>
<span class="c1">#         if save_dir is not None:</span>
<span class="c1"># </span>
<span class="c1">#             if os.path.isfile(save_dir):</span>
<span class="c1">#                 print(&#39;!!! &#39;,save_dir,&#39; file already exists&#39;)</span>
<span class="c1">#                 sys.exit()</span>
<span class="c1">#             </span>
<span class="c1">#             else:</span>
<span class="c1">#                 if not os.path.isdir(save_dir):</span>
<span class="c1">#                     try:</span>
<span class="c1">#                         os.mkdir(save_dir)</span>
<span class="c1">#                     except:</span>
<span class="c1">#                         print(&#39;!!! ERROR: Could not create &#39; , save_dir)</span>
<span class="c1">#                         sys.exit()</span>
<span class="c1"># </span>
<span class="c1">#             info_file=open(save_dir+&#39;/pyacs.info&#39;,&#39;w&#39;)</span>
<span class="c1"># </span>
<span class="c1">#         </span>
<span class="c1">#         # header &amp; print formats</span>
<span class="c1">#         </span>
<span class="c1">#         header   = &quot;site     long.      lat.     v_e     v_n     v_u    sv_e    sv_n    sv_u   #obs #camp   s_year   e_year d_year     se     sn     su   wrms_e   wrms_n   wrms_u&quot;</span>
<span class="c1">#         sep_line = &quot;--------------------------------------------------------------------------------------------------------------------------------------------------------------&quot;</span>
<span class="c1">#         fmt      = &quot;%4s %9.4lf  %8.4lf %7.2lf %7.2lf %7.2lf %7.2lf %7.2lf %7.2lf %6d %5d %8.3lf %8.3lf  %5.2lf %6.2lf %6.2lf %6.2lf %8.2lf %8.2lf %8.2lf&quot;</span>
<span class="c1">#         fmt_vna  = &quot;%4s %9.4lf  %8.4lf     N/A     N/A     N/A     N/A     N/A     N/A %6d %5d %8.3lf %8.3lf  %5.2lf %6.2lf %6.2lf %6.2lf %8.2lf %8.2lf %8.2lf&quot;</span>
<span class="c1">#         fmt_na   = &quot;%4s %9.4lf  %8.4lf     N/A     N/A     N/A     N/A     N/A     N/A %6d %5d %8.3lf %8.3lf  %5.2lf    N/A    N/A    N/A      N/A      N/A      N/A&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         if save_dir:</span>
<span class="c1">#             info_file.write(header+&quot;\n&quot;)</span>
<span class="c1">#             info_file.write(sep_line+&quot;\n&quot;)</span>
<span class="c1">#         </span>
<span class="c1">#         print(header)</span>
<span class="c1">#         print(sep_line)</span>
<span class="c1">#         # loop on Gts</span>
<span class="c1">#         </span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             </span>
<span class="c1">#             # if no data move to next gts</span>
<span class="c1">#             if gts.data is None:</span>
<span class="c1">#                 continue</span>
<span class="c1">#             </span>
<span class="c1">#             if lsite != [] and gts.code not in lsite:continue</span>
<span class="c1">#             code=gts.code</span>
<span class="c1">#             lon=gts.lon</span>
<span class="c1">#             lat=gts.lat</span>
<span class="c1">#             n_obs=gts.data.shape[0]</span>
<span class="c1">#             start_year=np.min(gts.data[:,0])</span>
<span class="c1">#             end_year=np.max(gts.data[:,0])</span>
<span class="c1">#             delta_year=end_year-start_year</span>
<span class="c1">#             n_camp=np.unique(list(map(int,list(gts.data[:,0])))).shape[0]</span>
<span class="c1">#             </span>
<span class="c1"># #            if delta_year&gt;2 and n_obs&gt;2 and n_camp&gt;1:</span>
<span class="c1">#             </span>
<span class="c1">#             # detrend</span>
<span class="c1">#             new_gts=gts.detrend_median( auto=True )</span>
<span class="c1"># </span>
<span class="c1">#             if new_gts is not None:</span>
<span class="c1">#                 </span>
<span class="c1">#                 [wrms_n,wrms_e,wrms_u]=new_gts.data[:,1:4].std(axis=0)*1000.0</span>
<span class="c1">#                 [s_n   ,   s_e,s_u   ]= np.median( np.fabs( np.diff( new_gts.data[:,1:4]*1000.0 , axis=0 ) ) , axis=0 )</span>
<span class="c1">#                 [vn,ve,vu,svn,sve,svu]=new_gts.velocity[:6]*1000.0</span>
<span class="c1">#                 </span>
<span class="c1">#                 fmt_str = (fmt % (code,lon,lat, ve,vn,vu, sve, svn, svu, n_obs,n_camp, start_year,end_year,delta_year,s_n,s_e,s_u,wrms_e,wrms_n,wrms_u))</span>
<span class="c1">#                 print(fmt_str)</span>
<span class="c1">#                 </span>
<span class="c1">#                 if save_dir is not None:</span>
<span class="c1">#                     info_file.write(&quot;%s\n&quot; % (fmt_str))</span>
<span class="c1">#                     </span>
<span class="c1">#             else:</span>
<span class="c1">#                 if gts.data.shape[0] &gt;= 2:</span>
<span class="c1">#                     # we can still get wrms and daily scatter</span>
<span class="c1">#                     [wrms_n,wrms_e,wrms_u]= gts.data[:,1:4].std(axis=0)*1000.0</span>
<span class="c1">#                     [s_n   ,   s_e,s_u   ]= np.median( np.fabs( np.diff( gts.data[:,1:4]*1000.0 , axis=0 ) ) , axis=0 )</span>
<span class="c1"># </span>
<span class="c1">#                     fmt_str = (fmt_vna % (code,lon,lat, n_obs,n_camp, start_year,end_year,delta_year,s_n,s_e,s_u,wrms_e,wrms_n,wrms_u))</span>
<span class="c1">#                     print(fmt_str)</span>
<span class="c1"># </span>
<span class="c1">#                     if save_dir is not None:</span>
<span class="c1">#                         info_file.write(&quot;%s\n&quot; % (fmt_str))</span>
<span class="c1">#                 </span>
<span class="c1">#                 else:</span>
<span class="c1">#                     fmt_str = (fmt_na % (code,lon,lat, n_obs,n_camp, start_year,end_year,delta_year))</span>
<span class="c1">#                     print(fmt_str)</span>
<span class="c1"># </span>
<span class="c1">#                     if save_dir is not None:</span>
<span class="c1">#                         info_file.write(&quot;%s\n&quot; % (fmt_str))</span>
<span class="c1">#                     </span>
<span class="c1"># </span>
<span class="c1">#         # write results</span>
<span class="c1">#         </span>
<span class="c1">#         if save_dir is not None:</span>
<span class="c1"># </span>
<span class="c1">#             info_file.close()</span>
<span class="c1">#             info = np.genfromtxt( save_dir+&#39;/pyacs.info&#39; , skip_header=2,dtype=str )</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#             header_info_ds = &quot;site    long.       lat.\n&quot;\</span>
<span class="c1">#                            + &quot;------------------------&quot;</span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_lphn.dat&#39;,info[:,:3] , fmt = &quot;%4s %10s %10s&quot; , header=header_info_ds )</span>
<span class="c1">#             </span>
<span class="c1">#             info_ds = info[ np.where(info[:,14]!=&#39;N/A&#39;) ]</span>
<span class="c1">#             header_info_ds = &quot;site daily_scatter_north (mm) daily_scatter_east (mm) daily_scatter_up (mm)\n&quot;\</span>
<span class="c1">#                            + &quot;---------------------------------------------------------------------------&quot;</span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_daily_scatter.dat&#39;,info_ds[:, (0,14,15,16) ] , fmt = &quot;%4s %20s %20s %20s&quot; , header=header_info_ds)</span>
<span class="c1">#             </span>
<span class="c1">#             info_ds = info[ np.where(info[:,17]!=&#39;N/A&#39;) ]</span>
<span class="c1">#             header_info_ds = &quot;site    wrms_north       wrms_east    wrms_up (mm) \n&quot;\</span>
<span class="c1">#                            + &quot;---------------------------------------------------&quot;</span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_wrms.dat&#39;,info_ds[:, (0,17,18,19) ] , fmt = &quot;%4s %15s %15s %15s&quot; , header=header_info_ds)</span>
<span class="c1">#             </span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_void.dat&#39;,info[:, (1,2,0) ] , fmt = &quot;%10s %10s   0.00   0.00   0.00   0.00    0.00   %s&quot;)</span>
<span class="c1"># </span>
<span class="c1">#             info_ds = info[ np.where(info[:,3]!=&#39;N/A&#39;) ]</span>
<span class="c1">#             header_info_ds = &quot;   long.       lat.         ve         vn        sve        svn    sven    site\n&quot;\</span>
<span class="c1">#                            + &quot;------------------------------------------------------------------------------------&quot;</span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_vel.dat&#39;,info_ds[:, (1,2,3,4,6,7,0) ] , fmt = &quot;%10s %10s %10s %10s %10s %10s    0.00    %s&quot;, header=header_info_ds)</span>
<span class="c1"># </span>
<span class="c1">#             header_info_ds = &quot;   long.       lat.        --       v_up       ---   sigma_v_up      ---    site\n&quot;\</span>
<span class="c1">#                            + &quot;---------------------------------------------------------------------------------&quot;</span>
<span class="c1">#             np.savetxt(save_dir+&#39;/pyacs_vel_up.dat&#39;,info_ds[:, (1,2,5,8,0) ] , fmt = &quot;%10s %10s      0.00 %10s      0.00 %12s     0.00    %s&quot; , header=header_info_ds)</span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         lcode=[]</span>
<span class="c1">#         for gts in self.lGts():lcode.append(gts.code)</span>
<span class="c1">#         for site in lsite:</span>
<span class="c1">#             if site not in lcode:print(&quot;!!! &quot;,site,&quot; in &quot;,lsite_file,&quot; and not in ts&quot;)</span>
<span class="c1">#         </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def add_offsets_dates(self,dates,verbose=False):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         add_offsets_dates to every Gts in current Sgts</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         New_Sgts=Sgts(read=False)</span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             if verbose:print(&quot;-- Processing &quot;,gts.code)</span>
<span class="c1">#             try:</span>
<span class="c1">#                 new_gts=gts</span>
<span class="c1">#                 new_gts.offsets_dates=dates</span>
<span class="c1">#             except (RuntimeError, TypeError, NameError):</span>
<span class="c1">#                 print(&quot;!!! Error processing &quot;,gts.code)</span>
<span class="c1">#                 continue</span>
<span class="c1">#             if isinstance(new_gts,Gts):</span>
<span class="c1">#                 New_Sgts.append(new_gts)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(&quot;!!! Error processing &quot;,gts.code, &quot;!!! No time series created.&quot;)</span>
<span class="c1">#         return(New_Sgts)</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def read_soln(self,soln,verbose=True):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         read a IGS soln file and add an offsets_dates for any P change in soln.</span>
<span class="c1">#         </span>
<span class="c1">#         :param soln: soln.snx IGS file</span>
<span class="c1">#         </span>
<span class="c1">#         :note: the method is in place</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#     </span>
<span class="c1">#         from pyacs.sol.discontinuity import Discontinuities</span>
<span class="c1">#         </span>
<span class="c1">#         fsoln=Discontinuities()</span>
<span class="c1">#         if verbose:print(&quot;-- Reading &quot;,soln)</span>
<span class="c1">#         fsoln.read_igs_discontinuity(soln)</span>
<span class="c1">#     </span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             if verbose:print(&quot;-- Adding offsets to &quot;,gts.code)</span>
<span class="c1">#             if gts.code in fsoln.lsite_offsets_dates:</span>
<span class="c1">#                 gts.offsets_dates=fsoln.lsite_offsets_dates[gts.code]</span>
<span class="c1">#     </span>
<span class="c1">#         return()</span>
<span class="c1">#         </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ##  DEFAULT PLOT FOR ALL TIMES SERIES</span>
<span class="c1"># ###################################################################</span>
<span class="c1"># </span>
<span class="c1">#     def plot_all(self,odir=&#39;.&#39;,save=True,show=False,verbose=True,center=False,date=[],):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Creates a default plot for all time series provided as a dictionary</span>
<span class="c1">#         save=True creates png files (default True)</span>
<span class="c1">#         show=True show time series in matplotlib graphic window (default False)</span>
<span class="c1">#         </span>
<span class="c1">#         :param odir: output directory</span>
<span class="c1">#         :save : boolean. True (default) will create png files</span>
<span class="c1">#         :show : boolean. show time series in matplotlib graphic window (default False)</span>
<span class="c1">#         :verbose: boolean. Verbose mode</span>
<span class="c1">#         :center: boolean. If True, the time series will be centered around 0. Default is False.</span>
<span class="c1">#         :date: list [start_date,end_date] in decimal year. Default is [] and will adapt the date scale according to the data</span>
<span class="c1">#         </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#     </span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             if verbose:print(&quot;-- Plotting &quot;,gts.code)</span>
<span class="c1">#             if save:</span>
<span class="c1">#                 png=gts.code+&#39;.png&#39;</span>
<span class="c1">#             gts.plot(date=date,save=png,show=show,center=center)</span>
<span class="c1">#     </span>
<span class="c1">#         return()</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ##  save velocity</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def save_velocity(self,vel_file=&#39;../stat/vel&#39;):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         save horizontal and up velocities</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         h_vel=vel_file+&#39;_en.gmt&#39;</span>
<span class="c1">#         u_vel=vel_file+&#39;_up.gmt&#39;</span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             try:</span>
<span class="c1">#                 gts.save_velocity(h_vel)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&quot;!!! Could not save &quot;,gts.code,&quot; in &quot;,h_vel)</span>
<span class="c1">#             try:</span>
<span class="c1">#                 gts.save_velocity(u_vel,up=True)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&quot;!!! Could not save &quot;,gts.code,&quot; in &quot;,u_vel)</span>
<span class="c1">#         return()</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ##  LAZY PYACS</span>
<span class="c1"># ###################################################################</span>
<span class="c1"># </span>
<span class="c1"># #     def lazy_pyacs(self,wdir=&#39;../lazy&#39;,save=True,verbose=True):</span>
<span class="c1"># #         &quot;&quot;&quot;</span>
<span class="c1"># #         Run lazy_pyacs on all time series</span>
<span class="c1"># #         &quot;&quot;&quot;</span>
<span class="c1"># #         import os.path</span>
<span class="c1"># #         if not os.path.isdir(wdir):</span>
<span class="c1"># #             try:</span>
<span class="c1"># #                 os.mkdir(wdir)</span>
<span class="c1"># #                 if verbose:print(&quot;=&gt; Writing lazy_pyacs results into dir &quot;,wdir)</span>
<span class="c1"># #             except:</span>
<span class="c1"># #                 print(&quot;!!! Could not create directory: &quot;,wdir)</span>
<span class="c1"># #                 </span>
<span class="c1"># #         lazy_Gts=Sgts(read=False)</span>
<span class="c1"># #         </span>
<span class="c1"># #         for gts in self.lGts():</span>
<span class="c1"># #             if verbose:print(&quot;=&gt; Lazy pyacs on &quot;,gts.code)</span>
<span class="c1"># #             try:</span>
<span class="c1"># #                 my_lazy_ts=gts.lazy_pyacs()</span>
<span class="c1"># #                 lazy_Gts.append(my_lazy_ts.remove_outliers().detrend())</span>
<span class="c1"># #                 my_lazy_ts.remove_outliers().detrend().write_pos(add_key=&#39;lazy&#39;,ts_dir=wdir)</span>
<span class="c1"># #             except:</span>
<span class="c1"># #                 print(&quot;!!! Could not complete lazy_pyacs analysis&quot;)</span>
<span class="c1"># #         </span>
<span class="c1"># #         lazy_Gts.save_velocity()</span>
<span class="c1"># #     </span>
<span class="c1"># #         return()</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def sel_rectangle(self,bounds,verbose=True):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         selects the time series for sites within a rectangles</span>
<span class="c1">#         </span>
<span class="c1">#         :param bounds: [lon_min,lon_max,lat_min,lat_max]</span>
<span class="c1">#         :pram verbose: verbose mode</span>
<span class="c1">#         </span>
<span class="c1">#         :return: a new Sgts instance</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         [lon_min,lon_max,lat_min,lat_max]=bounds</span>
<span class="c1"># </span>
<span class="c1">#         new_Sgts=Sgts(read=False)</span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             current_lon=gts.lon</span>
<span class="c1">#             current_lat=gts.lat</span>
<span class="c1">#             </span>
<span class="c1">#             if current_lon&gt;=lon_min and current_lon&lt;=lon_max&lt;=lon_max and current_lat&gt;= lat_min and current_lat&lt;=lat_max:</span>
<span class="c1">#                 if verbose:print(&quot;-- &quot;,gts.code,&quot; selected&quot;)</span>
<span class="c1">#                 new_Sgts.append(gts)</span>
<span class="c1">#         return(new_Sgts)</span>
<span class="c1">#         </span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1">#     def to_displacement(self,verbose=True,base_name=&#39;vel&#39;,wdir=&#39;.&#39;,up=False):</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         print displacements every dates as gmt psvelo files </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         # import</span>
<span class="c1">#         </span>
<span class="c1">#         import pyacs.lib.astrotime as AT</span>
<span class="c1">#         import pyacs.lib.vel_field as Velocity_Field</span>
<span class="c1">#         import pyacs.lib.gmtpoint as GMT_Point</span>
<span class="c1">#         import numpy as np</span>
<span class="c1">#         </span>
<span class="c1">#         # get the list of dates</span>
<span class="c1">#         </span>
<span class="c1">#         ldate=[]</span>
<span class="c1">#         for gts in self.lGts():</span>
<span class="c1">#             ldate=ldate+gts.data[:,0].tolist()</span>
<span class="c1"># </span>
<span class="c1">#         np_dates=np.array(sorted(list(set(ldate))))</span>
<span class="c1">#         </span>
<span class="c1">#         if verbose: print(&quot;=&gt; Found &quot;,np_dates.shape[0],&quot; dates&quot;)</span>
<span class="c1"># </span>
<span class="c1">#         # creates the gmt files</span>
<span class="c1">#         </span>
<span class="c1">#         date_ref=np_dates[0]</span>
<span class="c1">#         </span>
<span class="c1">#         for i in np.arange(np_dates.shape[0]):</span>
<span class="c1">#             date=np_dates[i]</span>
<span class="c1"># #        for date in sorted(ldate):</span>
<span class="c1">#             file_name=wdir+&#39;/&#39;+(&quot;%04d_&quot; % i)+base_name+&#39;.gmt&#39;</span>
<span class="c1">#             vel=Velocity_Field.Velocity_Field(file_name=file_name)</span>
<span class="c1">#             for gts in self.lGts():</span>
<span class="c1">#                 M=GMT_Point.GMT_Point(code=gts.code)</span>
<span class="c1">#                 </span>
<span class="c1">#                 tmp_gts=gts.extract_dates([date])</span>
<span class="c1">#                 </span>
<span class="c1">#                 if tmp_gts.data is not None:</span>
<span class="c1">#                     if tmp_gts.data.shape[0]==1:</span>
<span class="c1">#                         M.lon=gts.lon</span>
<span class="c1">#                         M.lat=gts.lat</span>
<span class="c1">#                         if up:</span>
<span class="c1">#                             M.Ve=0.0</span>
<span class="c1">#                             M.Vn=tmp_gts.data[0,3]*1.E3</span>
<span class="c1">#                             M.SVe=0.0</span>
<span class="c1">#                             M.SVn=tmp_gts.data[0,6]*1.E3</span>
<span class="c1">#                             M.SVen=0.0</span>
<span class="c1">#                         else:</span>
<span class="c1">#                             M.Ve=tmp_gts.data[0,2]*1.E3</span>
<span class="c1">#                             M.Vn=tmp_gts.data[0,1]*1.E3</span>
<span class="c1">#                             M.SVe=tmp_gts.data[0,5]*1.E3</span>
<span class="c1">#                             M.SVn=tmp_gts.data[0,4]*1.E3</span>
<span class="c1">#                             M.SVen=0.0</span>
<span class="c1">#                         </span>
<span class="c1">#                         vel.add_point(M)</span>
<span class="c1">#             </span>
<span class="c1">#             (mday,month,ut)=AT.decyear2cal(date)</span>
<span class="c1">#             (noday,ut)=AT.decyear2dayno(date)    </span>
<span class="c1">#             date_info=(&quot;step #%04d date %10.5lf %02d-%02d-%04d-%.1lf doy %03d | days since reference date +%4.1lf &quot; % \</span>
<span class="c1">#                        (i,date,mday,month,int(date),ut,noday,(date-date_ref)*365.25))</span>
<span class="c1"># </span>
<span class="c1">#             vel.write(comment=date_info)</span>
<span class="c1"># </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ##  MEDVEL</span>
<span class="c1"># ###################################################################</span>
<span class="c1"># </span>
<span class="c1">#     def medvel(self,outdir=None,verbose=False):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         Automatic velocity estimates using median estimator.</span>
<span class="c1">#         The code is adapted from the MIDAS approach (Blewitt et al., 2016).</span>
<span class="c1">#         </span>
<span class="c1">#         medvel fills the velocity attribute of every Gts from the current Sgts instance.</span>
<span class="c1">#         </span>
<span class="c1">#         returns the modified Sgts instance</span>
<span class="c1">#         Optionally, if outdir option is provided, writes the results in outdir</span>
<span class="c1">#         </span>
<span class="c1">#         :param: outdir: output directory, default None</span>
<span class="c1">#         :param: verbose: boolean, verbose mode</span>
<span class="c1">#         :param: warning: output warning file</span>
<span class="c1"># </span>
<span class="c1">#         :reference: Blewitt, G., Kreemer, C., Hammond, W. C., &amp; Gazeaux, J. (2016). MIDAS robust trend estimator for accurate GPS station velocities without step detection. Journal of Geophysical Research: Solid Earth, 121(3), 2054-2068.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1"># </span>
<span class="c1">#         import os</span>
<span class="c1">#         </span>
<span class="c1">#         # </span>
<span class="c1">#         </span>
<span class="c1">#         new_sgts = Sgts(read=False)</span>
<span class="c1">#         </span>
<span class="c1">#         # create output directory</span>
<span class="c1">#         </span>
<span class="c1">#         if outdir is not None:</span>
<span class="c1">#             </span>
<span class="c1">#             if os.path.isdir(outdir):</span>
<span class="c1">#                 print(&#39;!!! &#39;,outdir,&#39; directory already exists&#39;)</span>
<span class="c1">#                 sys.exit()</span>
<span class="c1">#             </span>
<span class="c1">#             elif os.path.isfile(outdir):</span>
<span class="c1">#                 print(&#39;!!! &#39;,outdir,&#39; file already exists&#39;)</span>
<span class="c1">#                 sys.exit()</span>
<span class="c1">#             </span>
<span class="c1">#             else:</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&#39;-- creating &#39; , outdir )</span>
<span class="c1">#                 </span>
<span class="c1">#                 os.mkdir(outdir)</span>
<span class="c1">#             </span>
<span class="c1">#             # output file names</span>
<span class="c1">#             </span>
<span class="c1">#             out_cgps = outdir+&#39;/vel_cgps.dat&#39;</span>
<span class="c1">#             out_sgps = outdir+&#39;/vel_sgps.dat&#39;</span>
<span class="c1">#     </span>
<span class="c1">#             out_cgps_up = outdir+&#39;/vel_cgps_up.dat&#39;</span>
<span class="c1">#             out_sgps_up = outdir+&#39;/vel_sgps_up.dat&#39;</span>
<span class="c1">#             </span>
<span class="c1">#             # open warning file</span>
<span class="c1">#             </span>
<span class="c1">#             fwarning = open(outdir+&#39;/warning.dat&#39;,&#39;w+&#39;)</span>
<span class="c1">#         </span>
<span class="c1">#         # start loop on sites</span>
<span class="c1">#         </span>
<span class="c1">#         lcode = self.lcode()</span>
<span class="c1">#         </span>
<span class="c1">#         for site in lcode:</span>
<span class="c1"># </span>
<span class="c1">#             </span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 print(&#39;-- Processing &#39;, site )</span>
<span class="c1"># </span>
<span class="c1">#             # check whether there is at least one year of data</span>
<span class="c1">#             </span>
<span class="c1">#             if ( self.__dict__[site].data[-1,0] - self.__dict__[site].data[0,0] ) &lt; 1.0 :</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Less than one year of data for site: %s&quot; % site)</span>
<span class="c1">#                 if outdir is not None:</span>
<span class="c1">#                     fwarning.write(&quot;-- Less than one year of data for site: %s\n&quot; % site)</span>
<span class="c1">#                 continue</span>
<span class="c1"># </span>
<span class="c1">#             # check whether there are at least three data</span>
<span class="c1">#             </span>
<span class="c1">#             if ( self.__dict__[site].data.shape[0] ) &lt; 3 :</span>
<span class="c1">#                 if verbose:</span>
<span class="c1">#                     print(&quot;-- Less than 3 data for site: %s&quot; % site)</span>
<span class="c1">#                 if outdir is not None:</span>
<span class="c1">#                     fwarning.write(&quot;-- Less than 3 data for site: %s\n&quot; % site)</span>
<span class="c1"># #                continue</span>
<span class="c1"># </span>
<span class="c1">#             # </span>
<span class="c1"># </span>
<span class="c1">#             detrended = self.__dict__[site].detrend_median( auto=True )</span>
<span class="c1"># </span>
<span class="c1">#             if ( detrended.velocity is None ):</span>
<span class="c1">#                 print( &quot;-- Problem in detrend_median for site : %s &quot; % site )</span>
<span class="c1">#                 continue</span>
<span class="c1"># </span>
<span class="c1">#             if  ( outdir is not None ):</span>
<span class="c1"># </span>
<span class="c1">#                 detrended.save_velocity(out_cgps,verbose=verbose)</span>
<span class="c1">#                 detrended.save_velocity(out_cgps_up,verbose=verbose,up=True)</span>
<span class="c1">#                 new_sgts.append( detrended )</span>
<span class="c1">#         </span>
<span class="c1">#         return( new_sgts )       </span>
<span class="c1"># </span>
<span class="c1">#                     </span>
<span class="c1"># ###################################################################</span>
<span class="c1"># ##  SAME_SITE</span>
<span class="c1"># ###################################################################</span>
<span class="c1"># </span>
<span class="c1">#     def same_site(self,dc=10, in_place=True, verbose=False):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         Check that all gts in the current Sgts are actually the same site. If a given time series is</span>
<span class="c1">#         found to be of two separate sites, then a new gts is added to the return Sgts instance.</span>
<span class="c1"># </span>
<span class="c1">#         param dc: critical distance to decide to split the time series</span>
<span class="c1">#         param in_place: if True modify current Sgts, False retuen a new Sgts</span>
<span class="c1">#         param verbose: verbose mode</span>
<span class="c1">#         </span>
<span class="c1">#         return: a new Sgts instance</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         </span>
<span class="c1">#         # import</span>
<span class="c1">#         import numpy as np</span>
<span class="c1"># </span>
<span class="c1">#         if not in_place:</span>
<span class="c1">#             new_Sgts = Sgts(read=False)</span>
<span class="c1"># </span>
<span class="c1">#         # start loop on sites</span>
<span class="c1">#         </span>
<span class="c1">#         lcode = self.lcode()</span>
<span class="c1">#         </span>
<span class="c1">#         for site in lcode:</span>
<span class="c1">#             </span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 print(&#39;-- Processing &#39;, site )</span>
<span class="c1"># </span>
<span class="c1">#             my_ts = self.__dict__[site].copy()</span>
<span class="c1"># </span>
<span class="c1">#             if my_ts.data_xyz is not None:</span>
<span class="c1">#                 data=my_ts.data_xyz[:,1:4]</span>
<span class="c1">#                 ddata=np.copy(my_ts.data_xyz[:,1:4])</span>
<span class="c1">#             </span>
<span class="c1">#             else:</span>
<span class="c1">#                 # if no data_xyz go to next gts</span>
<span class="c1">#                 print(&quot;!!! WARNING: data_xyz attribute required for method same_site and not found gts %s&quot; % (site))</span>
<span class="c1">#             </span>
<span class="c1">#             # ensure median calculation</span>
<span class="c1">#             if np.mod(data.shape[0],2)==0:</span>
<span class="c1">#                 # duplicates the last date</span>
<span class="c1">#                 ddata = np.vstack((ddata,ddata[-1,:]))</span>
<span class="c1">#             </span>
<span class="c1">#             median = np.median(ddata,axis=0)</span>
<span class="c1">#             dist_data= np.sqrt( np.sum( (data-median)**2,axis=1) )</span>
<span class="c1">#             </span>
<span class="c1">#             lindex = np.where(dist_data &gt; dc*1.E3 )</span>
<span class="c1">#             </span>
<span class="c1">#             # case gts needs to be split</span>
<span class="c1">#             if len( lindex[0] ) &gt; 0 :</span>
<span class="c1">#                 # create a new code</span>
<span class="c1">#                 </span>
<span class="c1">#                 new_code = my_ts.code[:3]+&#39;_&#39;</span>
<span class="c1">#                 if new_code in self.lcode():</span>
<span class="c1">#                     import sys</span>
<span class="c1">#                     print(&quot;!!! ERROR: try to create a new gts with code %s and it already exists.&quot; % (new_code))</span>
<span class="c1">#                     new_code = my_ts.code[:2]+&#39;__&#39;</span>
<span class="c1">#                     </span>
<span class="c1">#                 print(&quot;-- time series for site %s appears to include different sites because there are coordinates at %d dates %.1lf km from the median position&quot; % ( site, len(lindex) , np.max( ddata )*1.E-3 ) ) </span>
<span class="c1">#                 print(&quot;-- %s time series will be split into code %s and code %s&quot; % (site,site,new_code) )</span>
<span class="c1">#                 </span>
<span class="c1">#                 # create a new gts</span>
<span class="c1">#                 new_gts = Gts(code=new_code,data_xyz=np.copy(my_ts.data_xyz[lindex]))</span>
<span class="c1">#                 new_gts.xyz2neu(corr=True)</span>
<span class="c1"># </span>
<span class="c1">#                 # remove the line from my_ts                </span>
<span class="c1"># </span>
<span class="c1">#                 my_ts.data_xyz = np.delete( my_ts.data_xyz , lindex , axis=0 )</span>
<span class="c1"># </span>
<span class="c1">#                 my_ts.xyz2neu(corr=True)</span>
<span class="c1">#                 </span>
<span class="c1">#                 # update the ouput</span>
<span class="c1">#                 </span>
<span class="c1">#                 if in_place:</span>
<span class="c1">#                     self.append(new_gts)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     new_Sgts.append( new_gts )</span>
<span class="c1">#             </span>
<span class="c1"># </span>
<span class="c1">#             if in_place:</span>
<span class="c1">#                 self.__dict__[site] = my_ts</span>
<span class="c1">#             else:</span>
<span class="c1">#                 new_Sgts.append( my_ts )</span>
<span class="c1"># </span>
<span class="c1">#         if in_place:</span>
<span class="c1">#             return self</span>
<span class="c1">#         else:</span>
<span class="c1">#             return new_Sgts</span>
<span class="c1">#             </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
<span class="c1">#         </span>
        
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jean-Mathieu Nocquet IRD.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>